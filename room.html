<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Tracker Application</title>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script type="text/javascript">
	    var canvas = null;
            var context = null;
	    var socket = null;
	    var sensors = {};
            function on_load()
            {
			canvas = document.getElementById('canvas');
			context = canvas.getContext('2d');
                        var imageObj = new Image();
                        imageObj.onload = function() {
                                canvas.width=this.width;
                                canvas.height=this.height;
                                context.drawImage(imageObj, 0, 0, this.width, this.height);
				on_load2();
                        };
			// Need your own image here
                        imageObj.src = '/images/room.png';
            }
	    function on_load2()
	    {
		
		
		socket = io.connect("/");
            	/*Initializing the connection with the server via websockets */
            	socket.on("message",function(message) {
                	console.log("Message from the server arrived!")
                	parsed_message = JSON.parse(message);
			var id         = parsed_message.id;
			var x          = parsed_message.x;
			var y          = parsed_message.y;
			var width      = parsed_message.width;
			var height     = parsed_message.height;
			var staff_list = parsed_message.list;
			console.log(staff_list);
			create_detector(id, x, y, width, height, staff_list);
            	});
	    }

	    function draw_rectangle(x, y, width, height) 
  	    {
		var rectangle = {
        			borderWidth: 1,
				opacity: 0.4
		};
		rectangle['x']=x;
		rectangle['y']=y;
		rectangle['width']=width;
		rectangle['height']=height;
		console.log(rectangle);

        	context.beginPath();
        	context.rect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);
        	context.fillStyle = '#8ED6FF';
        	context.fill();
        	context.lineWidth = rectangle.borderWidth;
        	context.strokeStyle = 'black';
        	context.stroke();
		return rectangle;
      	    }

	    function create_detector(id, x, y, width, height, staff_list)
	    {
		console.log("Create detector:"+ id);
		if (id in sensors) {
		} else {
			sensors[id]=draw_rectangle(x,y,width,height);
		}
		var bold = document.createElement("b");
		bold.appendChild(document.createTextNode(staff_list));
		
		var old_element=document.getElementById(id);
		if (old_element) {
			if (document.getElementById(id).childNodes.length > 0 )
			{
				var child =  document.getElementById(id).children[0];
				// Remove div child
                		document.getElementById(id).removeChild(child);
				console.log("Replace text:" + staff_list +  old_element);
				old_element.appendChild(bold);
        		}
		} else {
			// Add detector
			var  element = document.createElement("div");
			var style ="background:#98bf21;height:" + height + "px;width:" + width +  "px;left:" + x + "px;top:" + y + "px;position:absolute;opacity:0.4";
			element.setAttribute('style', style);
			element.setAttribute('id', id);
			element.appendChild(bold);
			document.getElementById("body").appendChild(element);
			console.log("Created first detector" + staff_list);
		}
	    }

	    // Close socket on unload
	    function on_unload()
	    {
		console.log("Disconnect");
		if (socket != null) socket.disconnect();
	    }
        </script>
    </head>
    <body onload="on_load()" onunload="on_unload()">
	 <h1 style="color:blue;text-align:center;">
		Tracking Application
	 </h1>
	 <canvas id="canvas" width="600" height="600" position="center"></canvas>
    </body>
</html>
